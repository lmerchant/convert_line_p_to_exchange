Documentation of processing Line P data to exchange format

Main file to process exchange files is create_line_p_ctd_exchange.py

Placement of cruises want to convert is in cruise_list variable found in
process_raw_data.py


1) Use concatenated whole cruise ctd file

2) Map Line P cruise ID to expocode and use in process_raw_data.py under cruise_list

3) Using only stations starting with P in data set representing Line P data.

Formats include

P# (P followed by a number)

P stations with non numeric characters in the name in the concatenated ctd file for whole cruise

  PIE93, PA-001 to PA-011, P1/B8, P14-P15, P24-P25, P20.5, P15.7, PAR


  PIE93 in 2007-13   (https://www.waterproperties.ca/linep/2007-13/index.php)

  PA-001 in cruise 2007-13  (https://www.waterproperties.ca/linep/2007-13/index.php)
  PA-011 in 2018-001 (https://www.waterproperties.ca/linep/2018-001/index.php)

  expect PA-003 but written as PA003, see 2009-09
  PA004 and PA-004 both used, see 2010-13 and 2010-14

  P15.7 in 2010-14  (https://www.waterproperties.ca/linep/2010-14/index.php) 

  P20.5 in 2011-01 (https://www.waterproperties.ca/linep/2011-01/index.php)  

  P14-P15 in cruise 2014-19  (Not listed as that on https://www.waterproperties.ca/linep/2014-19/index.php but listed as that in the ctd file. Listed as blank on the website.)

  P24-P25 in cruise 2014-19  (Not listed as that on https://www.waterproperties.ca/linep/2014-19/index.php but listed as that in the ctd file. Listed as blank on the website.)
   
  P1/B8 in 2015-09  (https://www.waterproperties.ca/linep/2015-09/index.php)

  PAR in 2015-10  (https://www.waterproperties.ca/linep/2015-10/index.php)


From Marie Robert:

PIE is a WOCE line that we sampled back in 1999.  In 2007 we resampled one of the stations on that line.
The PA-0xx stations are where the NOAA moorings are deployed.

Most of the others are CTD casts that we did to get PAR data for productivity casts the next morning.  So they were done at a specific time (~local noon) as opposed to a specific location.

P1/B8 are two station names for the same location but depending on which program goes out.  Since at the end of that cruise we visited 2 lines from the other program we gave both names to the station.



4) Metadata to use

Metadata columns in ctd files:

File Name
Zone
FIL:START TIME YYYY/MM/DD
 HH:MM
LOC:EVENT_NUMBER
LOC:LATITUDE
LOC:LONGITUDE
LOC:STATION
INS:LOCATION

Notice time column name has beginning space in it.


Metadata columns used in exchange format header

FIL:START TIME YYYY/MM/DD
 HH:MM
LOC:LATITUDE
LOC:LONGITUDE
LOC:STATION

Zone not used since all date/times in UTC

LOC:EVENT_NUMBER used to create CASTNO in exchange format

LOC:STATION becomes STNBR


Metadata variables used in exchange format

NUMBER_HEADERS
EXPOCODE
STNBR
CASTNO
DATE
TIME
LATITUDE
LONGITUDE


5) Look at format of data sets and find out date and time 
formats and which need to be converted to exchange format.

Dates use both / and - in dates. File says dates of form YYYY/MM/DD but
really of form DD-MM-YY or DD/MM/YYYY. Will be converted to exchange YYYYMMDD

For FIL:START TIME YYYY/MM/DD, use two different versions for date

2007-01
17/02/2007 is of format DD/MM/YYYY

2012-13
15-08-12 is of format DD-MM-YY


Time has : in value, HH:MM, and will be converted to exchange format HHMM



6) Want to only save a subset of the data to exchange file and rename columns

Skip 
Oxygen:Dissolved:CTD:Volume [ml/l]

Skip 
Sigma-t:CTD [kg/m^3] and Sigma-t:CTD {kg/m^3]


Skip comments column in 2010-01

List columns to save and map to WHP name.

Put in list in order want columns to appear in exchange output file

Some data files call CTDSAL, CTDXMISS, and CTDFLUOR with different names and units so
account for this when importing columns

  [                             
    {'whpname' : 'CTDPRS' , 'longname':'Pressure:CTD [dbar]', 'units' : 'DBAR'},                          
    {'whpname' : 'CTDTMP' , 'longname':'Temperature:CTD [deg_C_(ITS90)]', 'units' : 'ITS-90'},
    {'whpname' : 'CTDSAL' , 'longname':'Salinity:CTD [PSS-78]', 'units' : 'PSS-78'},
    {'whpname' : 'CTDSAL' , 'longname':'Salinity:Practical:CTD [PSS-78]', 'units' : 'PSS-78'},
    {'whpname' : 'CTDOXY' , 'longname':'Oxygen:Dissolved:CTD:Mass [µmol/kg]', 'units' : 'UMOL/KG'},   
    {'whpname' : 'CTDBEAMCP' , 'longname':'Transmissivity:CTD [*/m]', 'units' : '/METER'},
    {'whpname' : 'CTDBEAMCP' , 'longname':'Transmissivity:CTD [%/m]', 'units' : '/METER'},
    {'whpname' : 'CTDFLUOR' , 'longname':'Fluorescence:CTD:Seapoint [mg/m^3]', 'units' : 'MG/M^3'},   
    {'whpname' : 'CTDFLUOR', 'longname': 'Fluorescence:CTD:Seapoint', 'units' : 'MG/M^3'},
    {'whpname' : 'CTDFLUOR', 'longname': 'Fluorescence:CTD [mg/m^3]', 'units' : 'MG/M^3'},
    {'whpname' : 'CTDFLUOR_TSG' , 'longname':'Fluorescence:CTD:Wetlabs [mg/m^3]', 'units' : 'MG/M^3'},
    {'whpname' : 'PAR' , 'longname':'PAR:CTD [µE/m^2/sec]', 'units' : 'UE/m^2/sec'}     
  ]   



Files with all the column name variations


2007-13
Pressure:CTD [dbar],
Temperature:CTD [deg_C_(ITS90)],
Salinity:CTD [PSS-78],
Transmissivity:CTD [*/m],
Oxygen:Dissolved:CTD:Mass [µmol/kg]
Fluorescence:CTD:Seapoint [mg/m^3],
PAR:CTD [µE/m^2/sec]


2007-15
Pressure:CTD [dbar],
Temperature:CTD [deg_C_(ITS90)],
Salinity:Practical:CTD [PSS-78],
Transmissivity:CTD [*/m],
Oxygen:Dissolved:CTD:Mass [µmol/kg]
Fluorescence:CTD [mg/m^3],
PAR:CTD [µE/m^2/sec]


2013-17
Pressure:CTD [dbar],
Temperature:CTD [deg_C_(ITS90)],
Salinity:CTD [PSS-78],
Transmissivity:CTD [%/m],
Oxygen:Dissolved:CTD:Mass [µmol/kg]
Fluorescence:CTD:Seapoint [mg/m^3],
PAR:CTD [µE/m^2/sec]


2015-01
Pressure:CTD [dbar],
Temperature:CTD [deg_C_(ITS90)],
Salinity:CTD [PSS-78],
Transmissivity:CTD [*/m],
Oxygen:Dissolved:CTD:Mass [µmol/kg]
Fluorescence:CTD:Seapoint,
PAR:CTD [µE/m^2/sec]


2017-01
Pressure:CTD [dbar],
Temperature:CTD [deg_C_(ITS90)],
Salinity:CTD [PSS-78],
Transmissivity:CTD [*/m],
Oxygen:Dissolved:CTD:Mass [µmol/kg]
Fluorescence:CTD:Seapoint [mg/m^3],
Fluorescence:CTD:Wetlabs [mg/m^3],
PAR:CTD [µE/m^2/sec]


7) Insert WHP flag columns for each data column

Set all flags initially to value of 2 

Fill empty cells with -999.

If no value present (fill -999), flag = 9
If value present and -99, flag = 5

Flag = 5 represents 'Not reported'
Flag = 9 represents 'Not sampled'

8) Change -99 fills to -999 which is Exchange fill value

9) Map event numbers to cast number

There are increasing event numbers at a single station.

Sort by station and event number. Map event numbers to a sequential cast number starting at 1
for each station.

e.g.

station   Event #    Cast #
P20       event 18   1
P20       event 19   2
P20       event 26   3


11) Rename files to Exchange format

<EXPOCODE>_<P_STAION>_<CASTNO>_ct1 for file

and folder <EXPOCODE>_<P_STATION> for folder


12) If stnbr has a slash in it, for file name, I replaced / with -

expocode 18DD20150607

P1/B8 which I converted to P1-B8 for filename. In exchange file,
STNBR is P1/B8



13) Include header lines from individual file as comments in exchange ctd files


14) 18DD20090127_2009-03-ctd-cruise.csv

2009-03

Report says cruise dates are: 2009-01-27/2009-02-10

But cruise id from menu reports different dates: Jan 28 to Feb 8, 2009

I created expocode using cruise report dates


15) Error for 18DD20090606 cruise id 2009-09

For P19, concatenated file says event 51 but table on website says should be event 52


16) Error for 18DD20090606 cruise id 2009-09

For P4, concatenated file says event 14 but table on website says should be event 15


17) Import pressure as a float to sort on.


18) If file name has PA-006. More than 5 characters long to use in output
ctd filename.  So take out the hyphen in the name.


19)  Columns wrong for 18DD20090127 which is cruise 2009-03

all have station number where should be pressure

There is an extra station column that messes up all the processing. Edit by hand.


Look at 18DD20090127_00P26_00006_ct1.csv,

pressure is P26


Example line from 2009-03 concatenated cruise file

2009-03-0001.ctd,UTC,28/01/2009, 23:04,1,48.59117,-123.50066,SIO3,SIO3,2.3,6.9224,28.2974,22.1793,33.5,5.54,241.9,2.123,84.5


So import into Excel, remove extra column and make sure headers are for correct columns.

Place in adjusted_data folder to call program using that file.

Should I replace file on CCHDO with corrected file of removing extra columns? No.





